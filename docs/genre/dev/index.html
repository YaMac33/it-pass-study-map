<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Genre | Sidenote</title>
  <meta name="description" content="ジャンル別の記事一覧" />

  <link rel="stylesheet" href="../../assets/style.css" />

  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; }
    a { color: inherit; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px 16px 48px; }
    header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 18px; }
    .muted { opacity: .75; font-size: 13px; }
    section { border: 1px solid rgba(127,127,127,.25); border-radius: 12px; padding: 16px; }
    ul { margin: 0; padding-left: 18px; }
    li { margin: 10px 0; }
    .list a { text-decoration: none; }
    .list a:hover { text-decoration: underline; }
    .meta { opacity: .75; font-size: 12px; margin-top: 4px; }
    .toplink { text-decoration: none; border: 1px solid rgba(127,127,127,.25); padding: 8px 10px; border-radius: 999px; font-size: 13px; }
    .toplink:hover { border-color: rgba(127,127,127,.55); }
    .error { color: #b00020; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 id="page-title">Genre</h1>
      <a class="toplink" href="../../">トップへ</a>
    </header>

    <div class="muted" id="page-sub">Loading…</div>

    <section style="margin-top:12px;">
      <ul class="list" id="list"></ul>
      <div id="err" class="muted error" style="display:none; margin-top:10px;"></div>
    </section>
  </div>

  <script>
    (async () => {
      const DATA_URL = "../../data/index.json";

      const elTitle = document.getElementById("page-title");
      const elSub = document.getElementById("page-sub");
      const elList = document.getElementById("list");
      const elErr = document.getElementById("err");

      const toText = (v) => (v == null ? "" : String(v));
      const normalizeKey = (v) =>
        toText(v).trim().toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9\-_]/g, "");

      const safePath = (p) => {
        const s = toText(p).trim();
        if (!s) return "";
        if (/^https?:\/\//i.test(s)) return s;
        return s.replace(/^\/*/, "");
      };

      const makeUrl = (relativePath) => new URL(relativePath, window.location.href).toString();

      const parseDateForSort = (s) => {
        const t = toText(s).trim();
        const ts = Date.parse(t);
        return Number.isFinite(ts) ? ts : -Infinity;
      };

      const clearChildren = (el) => { while (el.firstChild) el.removeChild(el.firstChild); };

      function getGenreFromUrl() {
        // 想定: .../docs/genre/<genre>/ もしくは .../docs/genre/<genre>/index.html
        const parts = window.location.pathname.split("/").filter(Boolean);
        const i = parts.lastIndexOf("genre");
        const raw = (i >= 0 && parts[i + 1]) ? parts[i + 1] : "";
        return normalizeKey(raw);
      }

      function showError(msg) {
        elErr.style.display = "block";
        elErr.textContent = msg;
      }

      function render(items, genreKey) {
        clearChildren(elList);

        if (!items.length) {
          const li = document.createElement("li");
          li.className = "muted";
          li.textContent = "該当記事がありません";
          elList.appendChild(li);
          return;
        }

        for (const it of items) {
          const title = toText(it.title) || "(no title)";
          const date = toText(it.date) || "";
          const category = toText(it.category) || "";
          const path = safePath(it.path);

          const li = document.createElement("li");

          const a = document.createElement("a");
          a.href = path ? makeUrl("../../" + path) : "#"; // genre配下からトップ基準へ
          a.textContent = title;

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = [
            date || null,
            category ? `category: ${category}` : null
          ].filter(Boolean).join(" / ");

          li.appendChild(a);
          if (meta.textContent) li.appendChild(meta);

          elList.appendChild(li);
        }

        elSub.textContent = `genre: ${genreKey} / ${items.length}件`;
        elTitle.textContent = `ジャンル：${genreKey}`;
        document.title = `Genre: ${genreKey} | Sidenote`;
      }

      try {
        const genreKey = getGenreFromUrl();
        if (!genreKey) {
          elSub.textContent = "";
          showError("ジャンル名をURLから取得できません。例：/genre/dev/ のような構造になっているか確認してください。");
          return;
        }

        const res = await fetch(DATA_URL, { cache: "no-cache" });
        if (!res.ok) throw new Error(`Failed to fetch ${DATA_URL} (HTTP ${res.status})`);

        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("index.json must be an array");

        const filtered = data
          .filter(it => normalizeKey(it?.genre) === genreKey)
          .sort((a, b) => parseDateForSort(b?.date) - parseDateForSort(a?.date));

        render(filtered, genreKey);
      } catch (e) {
        console.error(e);
        elSub.textContent = "";
        showError(`読み込みに失敗しました：${e?.message || e}`);
      }
    })();
  </script>
</body>
</html>
